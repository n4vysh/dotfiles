# Plugins
set-option -g @plugin 'tmux-plugins/tpm'
set-option -g @plugin 'tmux-plugins/tmux-yank'
set-option -g @plugin 'tmux-plugins/tmux-open'
set-option -g @plugin 'tmux-plugins/tmux-pain-control'
set-option -g @plugin 'wfxr/tmux-fzf-url'
set-option -g @plugin 'laktak/extrakto'
set-option -g @plugin 'nhdaly/tmux-better-mouse-mode'
set-option -g @plugin 'erikw/tmux-powerline'

set-option -g @yank_action 'copy-pipe'
set-option -g @copy_mode_put '.'
set-option -g @open-s 'https://www.google.com/search?q='
set-option -g @fzf-url-history-limit '2000'
set-option -g @extrakto_split_direction v
set-option -g @fzf-url-fzf-options \
  '--tmux bottom,100%,50% --no-preview --layout reverse --multi -0 --no-info --pointer â—'
set-option -g @scroll-without-changing-pane on
set-option -g @emulate-scroll-for-no-mouse-alternate-buffer on

run-shell '~/.tmux/plugins/tpm/tpm'

set-option -ag command-alias "extrakto-open=run-shell 'extrakto-open #{pane_id}'"

bind-key -T copy-mode-vi Tab extrakto-open

# Default options and keybinds
set-option -g prefix C-j
unbind-key C-b
bind-key C-j send-prefix
bind-key v run-shell '
  wl-paste -n |
  tmux load-buffer - &&
  tmux paste-buffer -p
'
bind-key C-c new-session
bind-key C-l switch-client -l
bind-key C-k list-keys
bind-key Enter new-window man tmux

## vim-like keybinds
bind-key o break-pane
bind-key C-s split-window -c "#{pane_current_path}" -v
bind-key C-v split-window -c "#{pane_current_path}" -h

## helix-like keybinds
bind-key -T copy-mode-vi g switch-client -T goto-mode
bind-key -T goto-mode g send-keys -X history-top
bind-key -T goto-mode e send-keys -X history-bottom
bind-key -T goto-mode l send-keys -X end-of-line \; send-keys -X cursor-left
bind-key -T goto-mode h send-keys -X start-of-line
bind-key -T goto-mode s send-keys -X back-to-indentation

bind-key -T copy-mode-vi m switch-client -T matching-mode
bind-key -T matching-mode m send-keys -X next-matching-bracket

bind-key C-a switch-client -T append-mode
bind-key -T append-mode i display-popup -E -w 30% -h 30% sh -c 'tmux send-keys "$(tunip)"'
bind-key -T append-mode d run-shell 'tmux send-keys "/usr/share/dirbuster/"'
bind-key -T append-mode w run-shell 'tmux send-keys "/usr/share/webshells/"'
bind-key -T append-mode C-w run-shell 'tmux send-keys "/usr/share/wordlists/"'

bind-key C-o switch-client -T open-mode
bind-key -T copy-mode-vi C-t send-keys -X copy-selection-no-clear \; \
  split-window -l '40%' -v "tmux show-buffer | tr '\n' ' ' | trans -b | less"
bind-key C-r copy-mode \; command-prompt -i -I "#{pane_search_string}" -T search -p "(search up)" { send-keys -X search-backward-incremental "%%" }

bind-key -T open-mode a new-window -c "#{pane_current_path}" opencode
bind-key -T open-mode c new-window -c "#{pane_current_path}" lazydocker
bind-key -T open-mode C-c new-window -c "#{pane_current_path}" k9s
bind-key -T open-mode d new-window -c "#{pane_current_path}" dbui
bind-key -T open-mode e new-window -c "#{pane_current_path}" $EDITOR
bind-key -T open-mode f new-window -c "#{pane_current_path}" yazi
bind-key -T open-mode m new-window -c "#{pane_current_path}" btop
bind-key -T open-mode n run-shell 'tmuxp load -y note >/dev/null'
bind-key -T open-mode Enter run-shell 'tmuxp load -y misc >/dev/null'
bind-key -T open-mode p new-window -c "#{pane_current_path}" gping example.com
bind-key -T open-mode C-p run-shell 'playerctl play-pause'
# send commands for container or remote machine
bind-key -T open-mode s split-window -v bash -c '
  cmd="$(pet search)"
  [[ -n $cmd ]] &&
    tmux set-buffer -- "$cmd" &&
    tmux last-pane &&
    tmux paste-buffer -p
'
bind-key -T open-mode t run-shell 'tmuxp load -y tasks >/dev/null'
bind-key -T open-mode v new-window -c "#{pane_current_path}" lazygit
bind-key -T open-mode C-v new-window -c "#{pane_current_path}" gh dash
bind-key -T open-mode w new-window -c "#{pane_current_path}" impala
bind-key -T open-mode C-w new-window -c "#{pane_current_path}" bluetui
bind-key -T open-mode z new-window -c "#{pane_current_path}" \; send-keys "zi" "Enter"
bind-key e new-window -n 'tmux.conf' sh -c "
  $EDITOR $XDG_CONFIG_HOME/tmux/tmux.conf{,.local} &&
    chezmoi re-add --source-path $XDG_CONFIG_HOME/tmux/tmux.conf &&
    tmux source-file $XDG_CONFIG_HOME/tmux/tmux.conf &&
    tmux display-message 'tmux.conf sourced'
"
# send commands for container or remote machine
bind-key C-e split-window -v bash -c '
  f="$(mktemp)"
  $EDITOR "$f"
  cmd="$(cat "$f")"
  [[ -n $cmd ]] &&
    tmux last-pane
    tmux set-buffer -- "$cmd" &&
    tmux paste-buffer -p
  rm "$f"
'

# OSC 133
bind-key -T copy-mode-vi C-n send-keys -X next-prompt
bind-key -T copy-mode-vi C-p send-keys -X previous-prompt

# better mouse mode
# https://github.com/NHDaly/tmux-better-mouse-mode/issues/24#issuecomment-337946622
bind-key -T copy-mode    C-WheelUpPane   send-keys -X -N 20 scroll-up
bind-key -T copy-mode-vi C-WheelUpPane   send-keys -X -N 20 scroll-up
bind-key -T copy-mode    C-WheelDownPane send-keys -X -N 20 scroll-down
bind-key -T copy-mode-vi C-WheelDownPane send-keys -X -N 20 scroll-down

set-option -g display-time 2000
set-option -s escape-time 10
set-window-option -g mode-keys vi
set-option -g default-terminal tmux-256color
set-option -ga terminal-overrides ",$TERM:Tc"
set-option -g focus-events on
set-option -g base-index 1
set-window-option -g pane-base-index 1
set-option -g mouse on
set-option -s set-clipboard on # OSC 52

# for yazi
set-option -g allow-passthrough on
set-option -ga update-environment TERM
set-option -ga update-environment TERM_PROGRAM

# OSC 8
# NOTE: press ctrl shift and click to open link in ghostty
# https://github.com/ghostty-org/ghostty/discussions/4281
set-option -ga terminal-features "*:hyperlinks"

# NOTE: use dual-line status
#       - status-format[0]: tmux display-message
#       - status-format[1]: tmux-powerline
# https://github.com/tmux/tmux/issues/1886#issuecomment-525382148
set -Fg 'status-format[1]' '#{status-format[0]}'
set -g 'status-format[0]' ''
set -g status 2

# Color
# NOTE: tmux-powerline not support mode-style and border-style
set -g mode-style "fg=#7aa2f7,bg=#3b4261"
set -g pane-border-style "fg=#3b4261"
set -g pane-active-border-style "fg=#7aa2f7"

# Undercurl support
set-option -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'

# Underscore colours
set-option -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

# WSL
# send keys instead of playerctl
if-shell '[ -n "$WSL_DISTRO_NAME" ]' \
  "bind-key -T open-mode C-p send-keys -t misc:1.0 'p'"

source-file -q $XDG_CONFIG_HOME/tmux/tmux.conf.local
