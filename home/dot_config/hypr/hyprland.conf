################
### MONITORS ###
################

monitor=,preferred,auto,1 # unscaled

###################
### MY PROGRAMS ###
###################

$terminal = ghostty
$menu = rofi -show drun -run-command 'uwsm app -- {cmd}'
$wobsock = $XDG_RUNTIME_DIR/wob.sock

#################
### AUTOSTART ###
#################

exec-once = uwsm app -- hyprpm reload                       # Window manager plugins
exec-once = uwsm app -- fcitx5 --replace -d >/dev/null 2>&1 # Input Method Framework
exec-once = uwsm app -- brightnessctl set 1                 # Brightness
exec-once = uwsm app -- waybar                              # Status bar
exec-once = uwsm app -- kanshi                              # Dynamic display configuration
exec-once = uwsm app -- swaync                              # Notification daemon
exec-once = uwsm app -- gnome-keyring-daemon --start        # Keyring
exec-once = uwsm app -- udiskie --automount                 # Mount Helper
exec-once = uwsm app -- tresorit-cli start                  # Cloud Storage
exec-once = uwsm app -- hypridle                            # Idle management daemon

# Overlay bar
# NOTE: wob systemd integration not working after logout
# https://github.com/francma/wob/issues/88
exec-once = rm -f $wobsock && mkfifo $wobsock && tail -f $wobsock | uwsm app -- wob

# Clipboard manager
#   cliphist:        manage clipboard history
#   wl-clip-persist: persist copied data before close application
exec-once = uwsm app -- wl-paste --type text --watch cliphist store
exec-once = uwsm app -- wl-paste --type image --watch cliphist store
# https://github.com/Linus789/wl-clip-persist/issues/3
# https://github.com/Linus789/wl-clip-persist/issues/12
exec-once = uwsm app -- wl-clip-persist --reconnect-tries 0 --clipboard regular

# polkit agent
exec-once = /usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1

# NOTE: `systemctl enable` not work, so start user path unit manually
exec-once = systemctl --user start reload-waybar.path
exec-once = systemctl --user start reload-kanshi.path
exec-once = systemctl --user start reload-swaync.path

exec-once = hyprsunset -t 3000 # Screen shader

# NOTE: Set desktop interface for GTK 3
# https://wiki.hyprland.org/FAQ/#gtk-settings-no-work--whatever
exec-once = uwsm app -- gsettings set org.gnome.desktop.interface gtk-theme 'Fluent-Dark'
exec-once = uwsm app -- gsettings set org.gnome.desktop.interface icon-theme 'Fluent-dark'
exec-once = uwsm app -- gsettings set org.gnome.desktop.interface font-name 'Noto Sans CJK JP 11'

# background applications
workspace = special:obsidian, gapsout:80
exec-once = [workspace special:obsidian silent] uwsm app -- obsidian

###################
### PERMISSIONS ###
###################

ecosystem {
    enforce_permissions = 1
}

permission = /usr/bin/grim, screencopy, allow
permission = /usr/lib/xdg-desktop-portal-hyprland, screencopy, allow
permission = /usr/bin/hyprpm, plugin, allow
# for hyprpm update
permission = /usr/bin/hyprpm, screencopy, allow
# NOTE: allow using screenshot for fade-in and fade-out
#       https://github.com/hyprwm/hyprlock/issues/836#issuecomment-3132484838
permission = /usr/bin/hyprlock, screencopy, allow

#####################
### LOOK AND FEEL ###
#####################

ecosystem {
    no_update_news = true
}

general {
    gaps_in = 5
    gaps_out = 20

    border_size = 2

    col.active_border = rgba(33ccffee) rgba(00ff99ee) 45deg
    col.inactive_border = rgba(595959aa)

    resize_on_border = true

    allow_tearing = false

    layout = hy3
}

decoration {
    rounding = 0

    active_opacity = 1.0
    inactive_opacity = 1.0

    shadow {
        enabled = true
        range = 4
        render_power = 3
        color = rgba(1a1a1aee)
    }

    blur {
        enabled = true
        size = 8
        passes = 1

        vibrancy = 0.1696
    }
}

animations {
    enabled = true

    #        NAME,           X0,   Y0,   X1,   Y1
    bezier = easeOutQuint,   0.23, 1,    0.32, 1
    bezier = easeInOutCubic, 0.65, 0.05, 0.36, 1
    bezier = linear,         0,    0,    1,    1
    bezier = almostLinear,   0.5,  0.5,  0.75, 1
    bezier = quick,          0.15, 0,    0.1,  1

    #           NAME,          ONOFF, SPEED, CURVE,        [STYLE]
    animation = global,        1,     10,    default
    animation = border,        1,     5.39,  easeOutQuint
    animation = windows,       1,     4.79,  easeOutQuint
    animation = windowsIn,     1,     4.1,   easeOutQuint, popin 87%
    animation = windowsOut,    1,     1.49,  linear,       popin 87%
    animation = fadeIn,        1,     1.73,  almostLinear
    animation = fadeOut,       1,     1.46,  almostLinear
    animation = fade,          1,     3.03,  quick
    animation = layers,        1,     3.81,  easeOutQuint
    animation = layersIn,      1,     4,     easeOutQuint, fade
    animation = layersOut,     1,     1.5,   linear,       fade
    animation = fadeLayersIn,  1,     1.79,  almostLinear
    animation = fadeLayersOut, 1,     1.39,  almostLinear
    animation = workspaces,    1,     1.94,  almostLinear, fade
    animation = workspacesIn,  1,     1.21,  almostLinear, fade
    animation = workspacesOut, 1,     1.94,  almostLinear, fade
    animation = zoomFactor,    1,     7,     quick
}

misc {
    focus_on_activate = true
    force_default_wallpaper = 1
    disable_hyprland_logo = true
}

#############
### INPUT ###
#############

input {
    kb_layout = us
    kb_variant =
    kb_model =
    kb_options = caps:none
    kb_rules =

    follow_mouse = 1

    sensitivity = 0

    touchpad {
        natural_scroll = true
    }
}

gesture = 4, horizontal, workspace

##############
### PLUGIN ###
##############

plugin {
    hy3 {
        tabs {
            height = 2
            padding = 6
            render_text = false
        }
    }
    hyprbars {
        bar_color = rgb(000000)
        bar_height = 25
        bar_title_enabled = false

        # NOTE: window borders are flickering
        # https://github.com/hyprwm/hyprland-plugins/issues/222
        bar_precedence_over_border = true

        hyprbars-button = rgb(d9d8d8), 11,   , hyprctl dispatch killactive
        hyprbars-button = rgb(d9d8d8), 11,   , hyprctl dispatch fullscreen 0
        hyprbars-button = rgb(d9d8d8), 11,   , scratchpad

        bar_padding = 10
        bar_button_padding = 10
    }
}

###################
### KEYBINDINGS ###
###################

$mod = SUPER

# SwayWM-like keybinds
bind = $mod, return, exec, uwsm app -- $terminal
bind = $mod SHIFT, e, exec, uwsm app -- wlogout -b 4

bind = $mod SHIFT, c, exec, uwsm app -- hyprctl reload
bind = $mod, q, killactive, # niri-like keybind
bind = $mod SHIFT, space, togglefloating,
bind = $mod, d, exec, uwsm app -- $menu
bind = $mod, f, fullscreen,
# hyprlang noerror true
bind = $mod, W, hy3:makegroup, tab, ephemeral
bind = $mod, b, hy3:makegroup, h, ephemeral
bind = $mod, v, hy3:makegroup, v, ephemeral
bind = $mod, e, hy3:makegroup, opposite, ephemeral
bind = $mod, space, hy3:togglefocuslayer,

# Move focus with mod + arrow keys
bind = $mod, h, hy3:movefocus, l
bind = $mod, l, hy3:movefocus, r
bind = $mod, k, hy3:movefocus, u
bind = $mod, j, hy3:movefocus, d

bind = $mod SHIFT, h, hy3:movewindow, l
bind = $mod SHIFT, l, hy3:movewindow, r
bind = $mod SHIFT, k, hy3:movewindow, u
bind = $mod SHIFT, j, hy3:movewindow, d
# hyprlang noerror false

# Switch workspaces with mod + [0-9]
bind = $mod, n, workspace, e+1
bind = $mod, p, workspace, e-1
bind = $mod, 1, workspace, 1
bind = $mod, 2, workspace, 2
bind = $mod, 3, workspace, 3
bind = $mod, 4, workspace, 4
bind = $mod, 5, workspace, 5
bind = $mod, 6, workspace, 6
bind = $mod, 7, workspace, 7
bind = $mod, 8, workspace, 8
bind = $mod, 9, workspace, 9
bind = $mod, 0, workspace, 10

# Move active window to a workspace silently with mod + SHIFT + [0-9]
# (stays on current workspace after moving the window)
bind = $mod SHIFT, n, movetoworkspacesilent, e+1
bind = $mod SHIFT, p, movetoworkspacesilent, e-1
bind = $mod SHIFT, 1, movetoworkspacesilent, 1
bind = $mod SHIFT, 2, movetoworkspacesilent, 2
bind = $mod SHIFT, 3, movetoworkspacesilent, 3
bind = $mod SHIFT, 4, movetoworkspacesilent, 4
bind = $mod SHIFT, 5, movetoworkspacesilent, 5
bind = $mod SHIFT, 6, movetoworkspacesilent, 6
bind = $mod SHIFT, 7, movetoworkspacesilent, 7
bind = $mod SHIFT, 8, movetoworkspacesilent, 8
bind = $mod SHIFT, 9, movetoworkspacesilent, 9
bind = $mod SHIFT, 0, movetoworkspacesilent, 10

# scratchpad
bind = $mod SHIFT, minus, exec, uwsm app -- scratchpad
bind = $mod, minus, exec, uwsm app -- scratchpad -g -m 'head -n 1'
bind = $mod CTRL, minus, togglespecialworkspace, scratchpad
workspace = special:scratchpad, gapsout:80

# Scroll through existing workspaces with mod + scroll
bind = $mod, mouse_down, workspace, e+1
bind = $mod, mouse_up, workspace, e-1

# Move/resize windows with mod + LMB/RMB and dragging
bindm = $mod, mouse:272, movewindow
bindm = $mod, mouse:273, resizewindow

# TODO: add resize mode after supported in hy3
# https://github.com/outfoxxed/hy3/issues/14

# Laptop multimedia keys for volume and LCD brightness
$file = /usr/share/sounds/freedesktop/stereo/audio-volume-change.oga
bindel = ,XF86AudioRaiseVolume, exec, uwsm app -- pamixer -ui 1 && uwsm app -- pamixer --get-volume > $wobsock && uwsm app -- pw-play $file
bindel = ,XF86AudioLowerVolume, exec, uwsm app -- pamixer -ud 1 && uwsm app -- pamixer --get-volume > $wobsock && uwsm app -- pw-play $file
bindel = ,XF86AudioMute, exec, uwsm app -- pamixer --toggle-mute && ( [ "$(uwsm app -- pamixer --get-mute)" = "true" ] && echo "$(uwsm app -- pamixer --get-volume) muted" > $wobsock ) || uwsm app -- pamixer --get-volume > $wobsock
bindel = ,XF86AudioMicMute, exec, uwsm app -- pamixer --default-source --toggle-mute && ( [ "$(uwsm app -- pamixer --default-source --get-mute)" = "true" ] && echo "$(uwsm app -- pamixer --default-source --get-volume) muted" > $wobsock ) || uwsm app -- pamixer --default-source --get-volume > $wobsock
bindel = ,XF86MonBrightnessUp, exec, uwsm app -- brightnessctl set 1%+ | sed -En 's/.*\(([0-9]+)%\).*/\1/p' > $wobsock
bindel = ,XF86MonBrightnessDown, exec, uwsm app -- brightnessctl set 1%- | sed -En 's/.*\(([0-9]+)%\).*/\1/p' > $wobsock

# Requires playerctl
bindl = , XF86AudioNext, exec, uwsm app -- playerctl next
bindl = , XF86AudioPause, exec, uwsm app -- playerctl play-pause
bindl = , XF86AudioPlay, exec, uwsm app -- playerctl play-pause
bindl = , XF86AudioPrev, exec, uwsm app -- playerctl previous

# dynamic menu
bind = $mod, period, exec, rofimoji
bind = $mod, semicolon, exec, uwsm app -- rofi -modi clipboard:cliphist-rofi-img -show clipboard -show-icons && uwsm app -- wtype -M ctrl -k v -m ctrl

# lock
bind = $mod CTRL, l, exec, hyprlock

# submap
bind = $mod, O, submap, 󱓞
submap = 󱓞
binde = , a, submap, 󰎇
binde = CTRL, a, exec, uwsm app -- $terminal -e wiremix
binde = CTRL, a, submap, reset
binde = , b, exec, uwsm app -- firefox
binde = , b, submap, reset
binde = ALT, b, exec, uwsm app -- torbrowser-launcher
binde = ALT, b, submap, reset
binde = CTRL, b, submap, 󰃟
binde = , c, exec, uwsm app -- hyprpicker -a
binde = , c, submap, reset
binde = , d, togglespecialworkspace, obsidian
binde = , d, submap, reset
binde = , e, exec, uwsm app -- proton-mail
binde = , e, submap, reset
binde = , f, exec, uwsm app -- $terminal -e yazi
binde = , f, submap, reset
binde = , i, exec, uwsm app -- slack
binde = , i, submap, reset
binde = CTRL, i, exec, uwsm app -- discord
binde = CTRL, i, submap, reset
binde = ALT, i, exec, uwsm app -- signal-desktop
binde = ALT, i, submap, reset
binde = , n, exec, uwsm app -- swaync-client -t -sw
binde = , n, submap, reset
binde = , m, exec, uwsm app -- $terminal -e btop
binde = , m, submap, reset
binde = CTRL, m, exec, uwsm app -- spotify-launcher
binde = CTRL, m, submap, reset
binde = , p, exec, uwsm app -- 1password
binde = , p, submap, reset
binde = CTRL, p, exec, uwsm app -- flatpak run io.ente.auth
binde = CTRL, p, submap, reset
binde = , t, exec, uwsm app -- burpsuite
binde = , t, submap, reset
binde = , r, exec, uwsm app -- remmina
binde = , r, submap, reset
binde = , w, exec, uwsm app -- $terminal -e impala
binde = , w, submap, reset
binde = CTRL, w, exec, uwsm app -- $terminal -e bluetui
binde = CTRL, w, submap, reset
binde = ALT, w, exec, uwsm app -- wireshark
binde = ALT, w, submap, reset
bind = , escape, submap, reset
submap = reset

submap = 󰎇
$file = /usr/share/sounds/freedesktop/stereo/audio-volume-change.oga
binde = , k, exec, uwsm app -- pamixer -ui 1 && uwsm app -- pamixer --get-volume > $wobsock && pw-play $file
binde = , j, exec, uwsm app -- pamixer -ud 1 && uwsm app -- pamixer --get-volume > $wobsock && pw-play $file
binde = , space, exec, uwsm app -- pamixer --toggle-mute && ( [ "$(uwsm app -- pamixer --get-mute)" = "true" ] && echo "$(uwsm app -- pamixer --get-volume) muted" > $wobsock ) || uwsm app -- pamixer --get-volume > $wobsock
binde = , space, submap, reset
binde = SHIFT, space, exec, uwsm app -- pamixer --default-source --toggle-mute && ( [ "$(uwsm app -- pamixer --default-source --get-mute)" = "true" ] && echo "$(uwsm app -- pamixer --default-source --get-volume) muted" > $wobsock ) || uwsm app -- pamixer --default-source --get-volume > $wobsock
binde = SHIFT, space, submap, reset
bind = , escape, submap, reset

submap = 󰃟
binde = , k, exec, uwsm app -- brightnessctl set 1%+ | sed -En 's/.*\(([0-9]+)%\).*/\1/p' > $wobsock
binde = , j, exec, uwsm app -- brightnessctl set 1%- | sed -En 's/.*\(([0-9]+)%\).*/\1/p' > $wobsock
bind = , escape, submap, reset

submap = reset

bind = $mod CTRL, s, submap, 󰄀
$file = ${HOME}/Pictures/screenshots/$(date +'%Y%m%d_%H%M%S').png
submap = 󰄀
binde = , w, exec, uwsm app -- grimblast --notify copysave output "$file"
binde = , w, submap, reset
binde = , c, exec, uwsm app -- grimblast --notify copysave active "$file"
binde = , c, submap, reset
binde = , p, exec, uwsm app -- grimblast --notify --freeze copysave area "$file"
binde = , p, submap, reset
binde = CTRL, w, exec, uwsm app -- grimblast --notify edit output
binde = CTRL, w, submap, reset
binde = CTRL, c, exec, uwsm app -- grimblast --notify edit active
binde = CTRL, c, submap, reset
binde = CTRL, p, exec, uwsm app -- grimblast --notify --freeze edit area
binde = CTRL, p, submap, reset
bind = , escape, submap, reset

submap = reset

bind = $mod CTRL, r, submap, 󰻂
bind = $mod CTRL, c, exec, killall -SIGINT wf-recorder; uwsm app -- notify-send screenrecord 'Stopped wf-recorder'
bind = $mod CTRL, c, submap, reset
$file = ${HOME}/Videos/screenrecords/$(date +'%Y%m%d_%H%M%S').mp4
submap = 󰻂
binde = , w, exec, uwsm app -- wf-recorder -f "$file"
binde = , w, submap, reset
binde = , p, exec, uwsm app -- wf-recorder -g "$(slurp)" -f "$file"
binde = , p, submap, reset
bind = , escape, submap, reset

submap = reset

bind = $mod, m, submap, 
submap = 
binde = , k, exec, uwsm app -- playerctl play-pause
binde = , k, submap, reset
binde = , j, exec, uwsm app -- playerctl position 10-
binde = , j, submap, reset
binde = , l, exec, uwsm app -- playerctl position 10+
binde = , l, submap, reset
binde = CTRL, p, exec, uwsm app -- playerctl previous
binde = CTRL, p, submap, reset
binde = CTRL, n, exec, uwsm app -- playerctl next
binde = CTRL, n, submap, reset
bind = , escape, submap, reset

submap = reset

bind = $mod SHIFT, m, submap, 󰍹
submap = 󰍹
binde = , d, exec, uwsm app -- nwg-displays
binde = , d, submap, reset
binde = , m, exec, uwsm app -- kanshictl switch mirror-dp-3
binde = , m, submap, reset
binde = , e, exec, uwsm app -- kanshictl switch extend-dp-3
binde = , e, submap, reset
binde = , p, exec, uwsm app -- wl-present mirror
binde = , p, submap, reset
bind = , escape, submap, reset

submap = reset

##############################
### WINDOWS AND WORKSPACES ###
##############################

# NOTE: ignore maximize requests from apps
#       and inhibit idle when fullscreen
windowrule {
    name = ignore-maximize
    match:class = .*

    suppress_event = maximize
    idle_inhibit = fullscreen
}

# NOTE: fix some dragging issues with XWayland
windowrule {
    name = fix-xwayland
    no_focus = on
    match:class = ^$
    match:title = ^$
    match:xwayland = 1
    match:float = 1
    match:fullscreen = 0
    match:pin = 0
}

windowrule {
    name = enable-float-when-picker
    float = on
    match:class = ^(hyprland-share-picker)$
}

# Firefox PinP
windowrule {
    name = firefox-pinp
    float = on
    pin = on
    move = ((monitor_w*0.745)) ((monitor_h*0.82))
    size = (monitor_w*0.25) (monitor_h*0.175)
    match:class = ^(firefox)$
    match:title = ^(Picture-in-Picture)$
}

# Blur
layerrule {
    name = rofi
    blur = on
    match:namespace = rofi
}

layerrule {
    name = wlogout
    blur = on
    match:namespace = logout_dialog
}

layerrule {
    name = swaync-control-center
    blur = on
    ignore_alpha = 0
    match:namespace = swaync-control-center
}

layerrule {
    name = swaync-notification-window
    blur = on
    ignore_alpha = 0
    match:namespace = swaync-notification-window
}
