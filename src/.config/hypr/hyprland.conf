################
### MONITORS ###
################

monitor=,preferred,auto,1 # unscaled

###################
### MY PROGRAMS ###
###################

$terminal = wezterm
$menu = rofi -show drun
$wobsock = $XDG_RUNTIME_DIR/wob.sock

#################
### AUTOSTART ###
#################

exec-once = systemctl --user import-environment DISPLAY WAYLAND_DISPLAY QT_QPA_PLATFORMTHEME
exec-once = dbus-update-activation-environment --systemd DISPLAY WAYLAND_DISPLAY XDG_CURRENT_DESKTOP=Hyprland QT_QPA_PLATFORMTHEME

exec-once = hyprpm reload                       # Window manager plugins
exec-once = fcitx5 --replace -d >/dev/null 2>&1 # Input Method Framework
exec-once = brightnessctl set 1                 # Brightness
exec-once = waybar                              # Status bar
exec-once = kanshi                              # Dynamic display configuration
exec-once = swaync                              # Notification daemon
exec-once = gnome-keyring-daemon --start        # Keyring
exec-once = udiskie --automount                 # Mount Helper
exec-once = tresorit-cli start                  # Cloud Storage
exec-once = hyprpaper                           # Wallpaper daemon
exec-once = hypridle                            # Idle management daemon

# Overlay bar
# NOTE: wob systemd integration not working after logout
# https://github.com/francma/wob/issues/88
exec-once = rm -f $wobsock && mkfifo $wobsock && tail -f $wobsock | wob

# Clipboard manager
#   cliphist:        manage clipboard history
#   wl-clip-persist: persist copied data before close application
exec-once = wl-paste --type text --watch cliphist store
exec-once = wl-paste --type image --watch cliphist store
# https://github.com/Linus789/wl-clip-persist/issues/3
# https://github.com/Linus789/wl-clip-persist/issues/12
exec-once = wl-clip-persist --reconnect-tries 0 --clipboard regular

# polkit agent
exec-once = /usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1

# NOTE: `systemctl enable` not work, so start user path unit manually
exec-once = systemctl --user start reload-waybar.path
exec-once = systemctl --user start reload-kanshi.path
exec-once = systemctl --user start reload-swaync.path

exec-once = hyprsunset -t 3000 # Screen shader

# NOTE: Set desktop interface for GTK 3
# https://wiki.hyprland.org/FAQ/#gtk-settings-no-work--whatever
exec-once = gsettings set org.gnome.desktop.interface gtk-theme 'Arc-Dark'
exec-once = gsettings set org.gnome.desktop.interface icon-theme 'Arc-Dark'
exec-once = gsettings set org.gnome.desktop.interface font-name 'Noto Sans CJK JP 11'

#############################
### ENVIRONMENT VARIABLES ###
#############################

env = XCURSOR_SIZE,24
env = HYPRCURSOR_SIZE,24
env = GTK_IM_MODULE,wayland
env = QT_IM_MODULE,fcitx
env = XMODIFIERS,@im=fcitx
env = QT_QPA_PLATFORMTHEME,gtk3
# for firefox
env = MOZ_ENABLE_WAYLAND,1
# for java applications
env = _JAVA_AWT_WM_NONREPARENTING,1
# for grimblast
env = GRIMBLAST_EDITOR,swappy -f

# NOTE: set graphical session information
# https://wiki.hyprland.org/Configuring/Environment-variables/#xdg-specifications
# https://wiki.archlinux.org/title/XDG_Desktop_Portal#Portal_does_not_start
# https://github.com/swaywm/sway/wiki#systemd-and-dbus-activation-environments
# https://github.com/swaywm/sway/issues/5732#issuecomment-1583336383
env = XDG_CURRENT_DESKTOP,Hyprland
env = XDG_SESSION_TYPE,wayland
env = XDG_SESSION_DESKTOP,Hyprland

#####################
### LOOK AND FEEL ###
#####################

ecosystem {
    no_update_news = true
}

general {
    gaps_in = 5
    gaps_out = 20

    border_size = 2

    col.active_border = rgba(33ccffee) rgba(00ff99ee) 45deg
    col.inactive_border = rgba(595959aa)

    resize_on_border = true

    allow_tearing = false

    layout = hy3
}

decoration {
    rounding = 0

    active_opacity = 1.0
    inactive_opacity = 1.0

    shadow {
        enabled = true
        range = 4
        render_power = 3
        color = rgba(1a1a1aee)
    }

    blur {
        enabled = true
        size = 8
        passes = 1

        vibrancy = 0.1696
    }
}

animations {
    enabled = true

    bezier = myBezier, 0.05, 0.9, 0.1, 1.05

    animation = windows, 1, 7, myBezier
    animation = windowsOut, 1, 7, default, popin 80%
    animation = border, 1, 10, default
    animation = borderangle, 1, 8, default
    animation = fade, 1, 7, default
    animation = workspaces, 1, 6, default
}

misc {
    force_default_wallpaper = 1
    disable_hyprland_logo = true
}

#############
### INPUT ###
#############

input {
    kb_layout = us
    kb_variant =
    kb_model =
    kb_options = caps:none
    kb_rules =

    follow_mouse = 1

    sensitivity = 0

    touchpad {
        natural_scroll = true
    }
}

gestures {
    workspace_swipe = true
    workspace_swipe_fingers = 4
    workspace_swipe_distance = 600
    workspace_swipe_min_speed_to_force = 10
}

##############
### PLUGIN ###
##############

plugin {
    hy3 {
        tabs {
            height = 2
            padding = 6
            render_text = false
        }
    }
    hyprbars {
        bar_color = rgb(000000)
        bar_height = 25
        bar_title_enabled = false

        # NOTE: window borders are flickering
        # https://github.com/hyprwm/hyprland-plugins/issues/222
        bar_precedence_over_border = true

        hyprbars-button = rgb(d9d8d8), 11,  , hyprctl dispatch killactive
        hyprbars-button = rgb(d9d8d8), 11,  , hyprctl dispatch fullscreen 0
        hyprbars-button = rgb(d9d8d8), 11,  , scratchpad

        bar_padding = 10
        bar_button_padding = 10
    }
}

###################
### KEYBINDINGS ###
###################

$mod = SUPER

# like SwayWM
bind = $mod, return, exec, $terminal
bind = $mod SHIFT, e, exec, wlogout -b 4

bind = $mod SHIFT, c, exec, hyprctl reload
bind = $mod SHIFT, q, killactive,
bind = $mod SHIFT, space, togglefloating,
bind = $mod, d, exec, $menu
bind = $mod, f, fullscreen,
# hyprlang noerror true
bind = $mod, W, hy3:makegroup, tab, ephemeral
bind = $mod, b, hy3:makegroup, h, ephemeral
bind = $mod, v, hy3:makegroup, v, ephemeral
bind = $mod, e, hy3:makegroup, opposite, ephemeral
bind = $mod, space, hy3:togglefocuslayer,

# Move focus with mod + arrow keys
bind = $mod, h, hy3:movefocus, l
bind = $mod, l, hy3:movefocus, r
bind = $mod, k, hy3:movefocus, u
bind = $mod, j, hy3:movefocus, d

bind = $mod SHIFT, h, hy3:movewindow, l
bind = $mod SHIFT, l, hy3:movewindow, r
bind = $mod SHIFT, k, hy3:movewindow, u
bind = $mod SHIFT, j, hy3:movewindow, d
# hyprlang noerror false

# Switch workspaces with mod + [0-9]
bind = $mod, n, workspace, e+1
bind = $mod, p, workspace, e-1
bind = $mod, 1, workspace, 1
bind = $mod, 2, workspace, 2
bind = $mod, 3, workspace, 3
bind = $mod, 4, workspace, 4
bind = $mod, 5, workspace, 5
bind = $mod, 6, workspace, 6
bind = $mod, 7, workspace, 7
bind = $mod, 8, workspace, 8
bind = $mod, 9, workspace, 9
bind = $mod, 0, workspace, 10

# Move active window to a workspace silently with mod + SHIFT + [0-9]
# (stays on current workspace after moving the window)
bind = $mod SHIFT, n, movetoworkspacesilent, e+1
bind = $mod SHIFT, p, movetoworkspacesilent, e-1
bind = $mod SHIFT, 1, movetoworkspacesilent, 1
bind = $mod SHIFT, 2, movetoworkspacesilent, 2
bind = $mod SHIFT, 3, movetoworkspacesilent, 3
bind = $mod SHIFT, 4, movetoworkspacesilent, 4
bind = $mod SHIFT, 5, movetoworkspacesilent, 5
bind = $mod SHIFT, 6, movetoworkspacesilent, 6
bind = $mod SHIFT, 7, movetoworkspacesilent, 7
bind = $mod SHIFT, 8, movetoworkspacesilent, 8
bind = $mod SHIFT, 9, movetoworkspacesilent, 9
bind = $mod SHIFT, 0, movetoworkspacesilent, 10

# scratchpad
bind = $mod SHIFT, minus, exec, scratchpad
bind = $mod, minus, exec, scratchpad -g -m 'head -n 1'
bind = $mod CTRL, minus, togglespecialworkspace, scratchpad
workspace = special:scratchpad, gapsout:80

# Scroll through existing workspaces with mod + scroll
bind = $mod, mouse_down, workspace, e+1
bind = $mod, mouse_up, workspace, e-1

# Move/resize windows with mod + LMB/RMB and dragging
bindm = $mod, mouse:272, movewindow
bindm = $mod, mouse:273, resizewindow

# TODO: add resize mode after supported in hy3
# https://github.com/outfoxxed/hy3/issues/14

# Laptop multimedia keys for volume and LCD brightness
$file = /usr/share/sounds/freedesktop/stereo/audio-volume-change.oga
bindel = ,XF86AudioRaiseVolume, exec, pamixer -ui 1 && pamixer --get-volume > $wobsock && pw-play $file
bindel = ,XF86AudioLowerVolume, exec, pamixer -ud 1 && pamixer --get-volume > $wobsock && pw-play $file
bindel = ,XF86AudioMute, exec, pamixer --toggle-mute && ( [ "$(pamixer --get-mute)" = "true" ] && echo "$(pamixer --get-volume) muted" > $wobsock ) || pamixer --get-volume > $wobsock
bindel = ,XF86AudioMicMute, exec, pamixer --default-source --toggle-mute && ( [ "$(pamixer --default-source --get-mute)" = "true" ] && echo "$(pamixer --default-source --get-volume) muted" > $wobsock ) || pamixer --default-source --get-volume > $wobsock
bindel = ,XF86MonBrightnessUp, exec, brightnessctl set 1%+ | sed -En 's/.*\(([0-9]+)%\).*/\1/p' > $wobsock
bindel = ,XF86MonBrightnessDown, exec, brightnessctl set 1%- | sed -En 's/.*\(([0-9]+)%\).*/\1/p' > $wobsock

# Requires playerctl
bindl = , XF86AudioNext, exec, playerctl next
bindl = , XF86AudioPause, exec, playerctl play-pause
bindl = , XF86AudioPlay, exec, playerctl play-pause
bindl = , XF86AudioPrev, exec, playerctl previous

# dynamic menu
bind = $mod, period, exec, rofimoji
bind = $mod, semicolon, exec, rofi -modi clipboard:cliphist-rofi-img -show clipboard -show-icons && wtype -M ctrl -k v -m ctrl

# lock
bind = $mod CTRL, l, exec, hyprlock

# submap
bind = $mod, O, submap, 󱓞
submap = 󱓞
binde = , a, submap, 󰎇
binde = , b, exec, firefox
binde = , b, submap, reset
binde = ALT, b, exec, torbrowser-launcher
binde = ALT, b, submap, reset
binde = CTRL, b, submap, 󰃟
binde = , c, exec, hyprpicker -a
binde = , c, submap, reset
binde = , e, exec, proton-mail
binde = , e, submap, reset
binde = , f, exec, $terminal -e nnn
binde = , f, submap, reset
binde = , i, exec, slack
binde = , i, submap, reset
binde = CTRL, i, exec, discord
binde = CTRL, i, submap, reset
binde = ALT, i, exec, signal-desktop
binde = ALT, i, submap, reset
binde = , n, exec, swaync-client -t -sw
binde = , n, submap, reset
binde = , m, exec, $terminal -e btm
binde = , m, submap, reset
binde = CTRL, m, exec, spotify-launcher
binde = CTRL, m, submap, reset
binde = , p, exec, 1password
binde = , p, submap, reset
binde = CTRL, p, exec, ente_auth
binde = CTRL, p, submap, reset
binde = , t, exec, burpsuite
binde = , t, submap, reset
binde = , r, exec, remmina
binde = , r, submap, reset
binde = , w, exec, $terminal -e impala
binde = , w, submap, reset
binde = CTRL, w, exec, $terminal -e bluetuith
binde = CTRL, w, submap, reset
binde = ALT, w, exec, wireshark
binde = ALT, w, submap, reset
bind = , escape, submap, reset
submap = reset

submap = 󰎇
$file = /usr/share/sounds/freedesktop/stereo/audio-volume-change.oga
binde = , k, exec, pamixer -ui 1 && pamixer --get-volume > $wobsock && pw-play $file
binde = , j, exec, pamixer -ud 1 && pamixer --get-volume > $wobsock && pw-play $file
binde = , space, exec, pamixer --toggle-mute && ( [ "$(pamixer --get-mute)" = "true" ] && echo "$(pamixer --get-volume) muted" > $wobsock ) || pamixer --get-volume > $wobsock
binde = , space, submap, reset
binde = SHIFT, space, exec, pamixer --default-source --toggle-mute && ( [ "$(pamixer --default-source --get-mute)" = "true" ] && echo "$(pamixer --default-source --get-volume) muted" > $wobsock ) || pamixer --default-source --get-volume > $wobsock
binde = SHIFT, space, submap, reset
bind = , escape, submap, reset

submap = 󰃟
binde = , k, exec, brightnessctl set 1%+ | sed -En 's/.*\(([0-9]+)%\).*/\1/p' > $wobsock
binde = , j, exec, brightnessctl set 1%- | sed -En 's/.*\(([0-9]+)%\).*/\1/p' > $wobsock
bind = , escape, submap, reset

submap = reset

bind = $mod CTRL, s, submap, 󰄀
$file = ${HOME}/Pictures/screenshots/$(date +'%Y%m%d_%H%M%S').png
submap = 󰄀
binde = , w, exec, grimblast --notify save output "$file"
binde = , w, submap, reset
binde = , c, exec, grimblast --notify save active "$file"
binde = , c, submap, reset
binde = , p, exec, grimblast --notify --freeze save area "$file"
binde = , p, submap, reset
binde = CTRL, w, exec, grimblast --notify edit output
binde = CTRL, w, submap, reset
binde = CTRL, c, exec, grimblast --notify edit active
binde = CTRL, c, submap, reset
binde = CTRL, p, exec, grimblast --notify --freeze edit area
binde = CTRL, p, submap, reset
bind = , escape, submap, reset

submap = reset

bind = $mod CTRL, r, submap, 󰻂
bind = $mod CTRL, c, exec, killall -SIGINT wf-recorder; notify-send screenrecord 'Stoped wf-recorder'
bind = $mod CTRL, c, submap, reset
$file = ${HOME}/Videos/screenrecords/$(date +'%Y%m%d_%H%M%S').mp4
submap = 󰻂
binde = , w, exec, wf-recorder -f "$file"
binde = , w, submap, reset
binde = , p, exec, wf-recorder -g "$(slurp)" -f "$file"
binde = , p, submap, reset
bind = , escape, submap, reset

submap = reset

bind = $mod, m, submap, 
submap = 
binde = , k, exec, playerctl play-pause
binde = , k, submap, reset
binde = , j, exec, playerctl position 10-
binde = , j, submap, reset
binde = , l, exec, playerctl position 10+
binde = , l, submap, reset
binde = CTRL, p, exec, playerctl previous
binde = CTRL, p, submap, reset
binde = CTRL, n, exec, playerctl next
binde = CTRL, n, submap, reset
bind = , escape, submap, reset

submap = reset

bind = $mod SHIFT, m, submap, 󰍹
submap = 󰍹
binde = , d, exec, nwg-displays
binde = , d, submap, reset
binde = , m, exec, kanshictl switch mirror-dp-3
binde = , m, submap, reset
binde = , e, exec, kanshictl switch extend-dp-3
binde = , e, submap, reset
binde = , p, exec, wl-present mirror
binde = , p, submap, reset
bind = , escape, submap, reset

submap = reset

##############################
### WINDOWS AND WORKSPACES ###
##############################

# Ignore maximize requests from apps. You'll probably like this.
windowrulev2 = suppressevent maximize, class:.*

# Fix some dragging issues with XWayland
windowrulev2 = nofocus,class:^$,title:^$,xwayland:1,floating:1,fullscreen:0,pinned:0

windowrulev2 = idleinhibit fullscreen, class:.*

windowrulev2 = float, class:^(hyprland-share-picker)$

# Firefox PinP
windowrulev2 = float, class:^(firefox)$, title:^(Picture-in-Picture)$
windowrulev2 = pin, class:^(firefox)$, title:^(Picture-in-Picture)$
windowrulev2 = move 74.5% 82%, class:^(firefox)$, title:^(Picture-in-Picture)$
windowrulev2 = size 25% 17.5%, class:^(firefox)$, title:^(Picture-in-Picture)$

# Blur
layerrule = blur, rofi
layerrule = blur, logout_dialog # wlogout
layerrule = blur, swaync-control-center
layerrule = ignorezero, swaync-control-center
layerrule = blur, swaync-notification-window
layerrule = ignorezero, swaync-notification-window
